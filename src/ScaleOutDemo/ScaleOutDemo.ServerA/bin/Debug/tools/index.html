<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>[XSockets.NET]</title>
    <!--<link rel="icon" href="/favicon.ico" type="image/icon">-->
    <style>
        body {
            font-family: Consolas;
            margin: 2px;
        }

        .controller {
            background: #1782cc;
            color: #f5f5f5;
            padding: 15px;
        }

        textarea {
            width: 500px;
            height: 45px;
        }

        button {
            padding: 15px;
            margin: 5px;
        }

        .circleBase {
            border-radius: 50%;
            width: 30px;
            height: 30px;            
            border: 2px solid black;
        }
        
        .online {
            background: #338217;
        }
        .offline {
            background: #c53030;
        }
    </style>
</head>
<body>
    <h2>
        Test your <span style="color:#1782cc; font-weight:bolder;">X</span>Sockets controllers without writing code!
    </h2>
    <div>
        <div id="statesymbol" class="circleBase offline"></div>
        <div id="state">Unknown</div>
    </div>
    <hr />
    <div id="messages"></div>
    <div id="proxy">

    </div>
    <script src="xsockets.latest.js"></script>
    <script>
        //All information about controllers that we can call
        var controllerInfo = undefined;

        //Open a native websocket with the sub-protocol ControllerProxy
        var ws = new xsockets.client('ws://localhost:4502', ['servermetadata']);

        var metadata = ws.controller('servermetadata');

        //Setup event for onopen
        metadata.onOpen = function (connInfo) {
            document.querySelector('#state').innerText = 'Socket Connected';
            document.querySelector('#statesymbol').classList.add('online');
            document.querySelector('#statesymbol').classList.remove('offline');
        };
        //ws.onopen = function () {
        //    document.querySelector('#state').innerText = 'Socket Connected';
        //    document.querySelector('#statesymbol').classList.add('online');
        //    document.querySelector('#statesymbol').classList.remove('offline');
        //}
        //Setup event for onclose
        metadata.onClose = function () {
            document.querySelector('#state').innerText = 'Socket Disconnected';
            document.querySelector('#statesymbol').classList.add('offline');
            document.querySelector('#statesymbol').classList.remove('online');
        };
        //ws.onclose = function () {
        //    document.querySelector('#state').innerText = 'Socket Disconnected';
        //    document.querySelector('#statesymbol').classList.add('offline');
        //    document.querySelector('#statesymbol').classList.remove('online');
        //}
        //ws.onerror = function (err) {
        //    console.log('err', err);
        //};
        //Setup event for onmessage
        metadata.on('init', function (d) {
            console.log(d);
        });

        ws.open();
        /*
        ws.onmessage = function (message) {
            //Since XSockets have a predefined format we need to parse the message
            var model = JSON.parse(message.data);
            console.log(model);
            //If controller open/close, do nothing
            if (model.T == 2) {
                document.querySelector("#h2-" + model.C).innerText = model.C + " Open";
                return;
            }
            if (model.T == 3) {
                document.querySelector("#h2-" + model.C).innerText = model.C + " Closed";
                return;
            }

            if (model.T == 'proxy' && model.C == 'null') {
                controllerInfo = JSON.parse(model.D);
                //clear content
                document.querySelector('#proxy').innerHTML = "";
                //build controller info
                console.log(controllerInfo);
                controllerInfo.forEach(function (c) {
                    //if (c.Alias == 'photon') {
                        var h2 = document.createElement('h2');
                        h2.classList.add('controller');
                        h2.id = "h2-" + c.Alias;
                        var h2text = document.createTextNode(c.Alias);
                        h2.appendChild(h2text)
                        document.querySelector('#proxy').appendChild(h2);

                        c.Methods.forEach(function (m) {
                            var h3 = document.createElement('h3');
                            var h3text = document.createTextNode("");
                            h3.appendChild(h3text)
                            document.querySelector('#proxy').appendChild(h3);

                            if (m.parameters.length == 0) {
                                h3.innerText = m.Method + "()";
                                var btn = document.createElement('button');
                                btn.innerText = 'invoke';
                                btn.onclick = function () {
                                    //alert(JSON.stringify(json));
                                    ws.send(JSON.stringify({ C: c.Alias, T: m.Method }));
                                };
                                document.querySelector('#proxy').appendChild(btn);
                            }
                            if (m.parameters.length > 1) {
                                var json = {};
                                var signature = m.Method + "(";
                                m.parameters.forEach(function (p) {
                                    json[p.Name] = JSON.parse(p.Json);
                                    signature += p.Type + " " + p.Name + ", "
                                });
                                signature = signature.substring(0, signature.length - 2) + ")";
                                //var span = document.createElement('p');
                                h3.innerText = signature;
                                //var spantext = document.createTextNode(signature);
                                //span.appendChild(spantext);
                                //document.querySelector("#proxy").appendChild(span);

                                //var span = document.createElement('p');
                                //var spantext = document.createTextNode(signature);
                                //span.appendChild(spantext)
                                //document.querySelector("#proxy").appendChild(span);
                                //console.log(json);
                                var wrapper = document.createElement('div');
                                var code = document.createElement('textarea');
                                code.type = 'text';
                                code.value = JSON.stringify(json);
                                code.id = m.Method;
                                var btn = document.createElement('button');
                                btn.innerText = 'invoke';
                                btn.onclick = function () {
                                    ws.send(JSON.stringify({ C: c.Alias, T: m.Method, D: document.querySelector('#' + m.Method).value }));
                                };
                                //var div = document.createElement('div');
                                //var divtext = document.createTextNode(p.Type + ', ' + p.Name + ', ' + p.Json);
                                //div.appendChild(divtext)
                                wrapper.appendChild(code);
                                wrapper.appendChild(btn);

                                document.querySelector('#proxy').appendChild(wrapper);
                                //document.querySelector('#proxy').appendChild(btn);
                            }
                            if (m.parameters.length == 1) {

                                var code = document.createElement('textarea');
                                code.type = 'text';
                                code.value = m.parameters[0].Json;
                                code.id = m.Method;
                                var btn = document.createElement('button');
                                btn.innerText = 'invoke';

                                h3.innerText = m.Method + "(" + m.parameters[0].Type + " " + m.parameters[0].Name + ")";

                                btn.onclick = function () {
                                    //console.log(document.querySelector('#'+m.Name).value);
                                    //alert(m.parameters[0].Json);
                                    ws.send(JSON.stringify({ C: c.Alias, T: m.Method, D: document.querySelector('#' + m.Method).value }));
                                };
                                //var div = document.createElement('div');
                                //var divtext = document.createTextNode(p.Type + ', ' + p.Name + ', ' + p.Json);
                                //div.appendChild(divtext)
                                document.querySelector('#proxy').appendChild(code);
                                document.querySelector('#proxy').appendChild(btn);
                            }

                            var messageElement = document.createElement('div');
                            messageElement.id = 'message-' + c.Alias + '-' + m.Method;
                            var messageElementText = document.createTextNode("");
                            messageElement.appendChild(messageElementText);
                            document.querySelector('#proxy').appendChild(messageElement);
                        });
                    //}
                });

            }
            else {
                var data = JSON.parse(model.D);
                console.log(data);
                console.log('#message-' + model.C + '-' + model.T);
                document.querySelector('#message-' + model.C + '-' + model.T).innerText = model.D;
            }
        }
        */
        //send message on click
        //document.querySelector('#send').onclick = function (evt) {
        //    evt.stopPropagation();
        //    var message = "Hello FullDuplex World";
        //    //construct message that is expected by xsockets
        //    var json = { D: message, T: 'say', C: 'chat' };
        //    ws.send(JSON.stringify(json));
        //};


    </script>
</body>
</html>