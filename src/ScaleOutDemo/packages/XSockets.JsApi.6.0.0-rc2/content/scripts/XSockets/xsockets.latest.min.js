var controller=function(){function n(n,t){this._isOpen=!1;this._subscriptions={};this.promises={};this.onOpen=function(){};this.onClose=function(){};this.onMessage=function(){};this._transport=n;this.name=t}return n.prototype.dispatchEvent=function(n){switch(n.T){case xsockets.events.open:this._isOpen=!0;var t=JSON.parse(n.D);this._controllerId=t.CI;this._transport.setPersistentId(t.PI);this.onOpen(n.D);break;case xsockets.events.close:this._isOpen=!1;this.onClose();break;default:if(!this.firePromise(n)&&!this.fireSubscription(n))this.onMessage(n)}},n.prototype.firePromise=function(n){var t=this.promises[n.T];return t!==undefined?(n.messageType===messageType.text?t(JSON.parse(n.D)):t(n.D),delete this.promises[n.T],!0):!1},n.prototype.fireSubscription=function(n){var t=this._subscriptions[n.T];return t!==undefined?(n.messageType==messageType.text?t(JSON.parse(n.D)):t({binary:n.B,metadata:n.D}),!0):!1},n.prototype.open=function(){this._transport.isConnected()&&!this._isOpen&&this._transport.socket.send(new message(this.name,xsockets.events.init))},n.prototype.close=function(n){n===void 0&&(n=!1);this._transport.isConnected()&&this._isOpen&&this._transport.socket.send(new message(this.name,xsockets.events.close));this.onClose();n&&this._transport.disposeController(this)},n.prototype.on=function(n,t){n=n.toLowerCase();typeof t=="function"&&(this._subscriptions[n]=t);typeof t=="undefined"&&delete this._subscriptions[n]},n.prototype.off=function(n){n=n.toLowerCase();delete this._subscriptions[n]},n.prototype.invoke=function(n,t){if(n=n.toLowerCase(),this._transport.isConnected()){t===undefined&&(t="");var i=new message(this.name,n,t);this._transport.socket.send(i)}return new promise(this,n)},n.prototype.invokeBinary=function(n,t,i){i===void 0&&(i=undefined);n=n.toLowerCase();var r=new message(this.name,n,i,t);return this._transport.socket.send(r.createBuffer()),this},n.prototype.subscribe=function(n,t){n=n.toLowerCase();this.on(n,t);if(this._transport.isConnected()&&typeof t=="function"){var i=new message(this.name,xsockets.events.subscribe,{T:n,A:!1});this._transport.socket.send(i)}},n.prototype.unsubscribe=function(n){if(n=n.toLowerCase(),delete this._subscriptions[n],this._transport.isConnected()){var t=new message(this.name,xsockets.events.unsubscribe,{T:n,A:!1});this._transport.socket.send(t)}},n.prototype.publish=function(n,t){n=n.toLowerCase();this.invoke(n,t)},n.prototype.setProperty=function(n,t){this.invoke("set_"+n,t)},n.prototype.getProperty=function(n,t){var i=this;this.on("get_"+n,function(r){i.off("get_"+n);t(r)});this.invoke("get_"+n,undefined)},n}(),messageType,message,xsockets,promise,xsocketsClient;(function(n){n[n.text=0]="text";n[n.binary=1]="binary"})(messageType||(messageType={}));message=function(){function n(n,t,i,r){i===void 0&&(i=undefined);r===void 0&&(r=undefined);this.C=n;this.T=t;this.B=r;this.D=i!==undefined&&typeof i!="string"?JSON.stringify(i):i;this.messageType=this.B==undefined?messageType.text:messageType.binary}return n.prototype.createBuffer=function(){var n=this.toString(),t=new Uint8Array(this.longToByteArray(n.length));return this.appendBuffer(this.appendBuffer(t,this.stringToBuffer(n)),this.B)},n.prototype.extractMessage=function(){var u=function(n){return String.fromCharCode.apply(null,new Uint16Array(n))},t=function(n){for(var t=0,i=n.byteLength-1;i>=0;i--)t=t*256+n[i];return t},i=new Uint8Array(this.B,0,8),f=t(i),r=8+t(i),e=new Uint8Array(this.B,r,this.B.byteLength-r),o=new Uint8Array(this.B,8,f),n=this.parse(u(o),e);return n.D=typeof n.D=="object"?n.D:JSON.parse(n.D),n},n.prototype.parse=function(t,i){var r=JSON.parse(t);return console.log("!!!"+r),new n(r.C,r.T,r.D||JSON.stringify({}),i)},n.prototype.toString=function(){return JSON.stringify({C:this.C,D:this.D,T:this.T,Q:this.Q,R:this.R,I:this.I})},n.prototype.appendBuffer=function(n,t){var i=new Uint8Array(n.byteLength+t.byteLength);return i.set(new Uint8Array(n),0),i.set(new Uint8Array(t),n.byteLength),i.buffer},n.prototype.stringToBuffer=function(n){for(var i=n.length,r=new Array(i),t=0;t<i;t++)r[t]=n.charCodeAt(t)&255;return new Uint8Array(r).buffer},n.prototype.longToByteArray=function(n){for(var r,t=[0,0,0,0,0,0,0,0],i=0;i<t.length;i++)r=n&255,t[i]=r,n=(n-r)/256;return t},n}(),function(n){var t,i,r;n.version="6.0.0-rc2";t=function(){function n(){}return n.authfailed="0",n.init="1",n.open="2",n.close="3",n.error="4",n.subscribe="5",n.unsubscribe="6",n.ping="7",n.pong="8",n}();n.events=t;i=function(){function n(){}return n.set="s1",n.get="s2",n.clear="s3",n.remove="s4",n}();n.storage=i;r=function(){function n(){}return n.guid=function(){for(var n,t=n="";n++<36;t+=n*51&52?(n^15?8^Math.random()*(n^20?16:4):4).toString(16):"-");return t},n}();n.utils=r}(xsockets||(xsockets={}));promise=function(){function n(n,t){this._controller=n;this._name=t}return n.prototype.then=function(n){this._controller.promises[this._name]=n},n}();xsocketsClient=function(){function n(n,t){t===void 0&&(t=[]);this._autoReconnect=!1;this._autoReconnectTimeout=5e3;this._readyState=WebSocket.CLOSED;this.onOpen=function(){};this.onAuthenticationFailed=function(){};this.onClose=function(){};this.onMessage=function(){};this.onError=function(){};this._parameters={};this._persistentId=localStorage.getItem(n);this._server=n;this.subprotocol="XSocketsNET";this._controllers=[];for(var i in t)this._controllers.push(new controller(this,t[i].toLowerCase()))}return n.prototype.autoReconnect=function(n,t){n===void 0&&(n=!0);t===void 0&&(t=5e3);this._autoReconnect=n;this._autoReconnectTimeout=t},n.prototype.setParameters=function(n){this._parameters=n},n.prototype.setPersistentId=function(n){this._persistentId=n;localStorage.setItem(this._server,this._persistentId)},n.prototype.open=function(){var n=this,t=this;(this.socket===undefined||this.socket.readyState!=WebSocket.OPEN)&&(this._parameters.persistentid=this._persistentId,this.socket=new WebSocket(this._server+this.querystring(),[this.subprotocol]),this.socket.binaryType="arraybuffer",this.socket.onopen=function(t){n._readyState=WebSocket.OPEN;n.onOpen(t);for(var i in n._controllers)n.sendtext(new message(n._controllers[i].name,xsockets.events.init))},this.socket.onclose=function(i){if(n.socket=undefined,n._readyState==WebSocket.OPEN){n.onClose(i);for(var r in n._controllers)n._controllers[r].close()}n._readyState=WebSocket.CLOSED;n._autoReconnect&&setTimeout(function(){t.open()},n._autoReconnectTimeout)},this.socket.onmessage=function(t){var i,r,u;if(typeof t.data=="string"){if(i=JSON.parse(t.data),r=new message(i.C,i.T,i.D,undefined),r.T==xsockets.events.authfailed){n.onAuthenticationFailed(r.D);n.close(!1);return}if(u=n.controller(r.C,!1),u==undefined)n.onMessage(i);else u.dispatchEvent(r)}else if(typeof t.data=="object"){var e=new message("","","",t.data),f=e.extractMessage(),u=n.controller(f.C,!1);if(u==undefined)n.onMessage(t.data);else u.dispatchEvent(f)}},this.socket.onerror=function(t){n.onError(t)})},n.prototype.close=function(n){n===void 0&&(n=!1);this._autoReconnect=n;this.socket!=undefined&&this.socket.close()},n.prototype.controller=function(n,t){var i,r;t===void 0&&(t=!0);i=undefined;for(r in this._controllers)if(this._controllers[r].name===n.toLowerCase()){i=this._controllers[r];break}return i===undefined&&t&&(i=new controller(this,n.toLocaleLowerCase()),this._controllers.push(i),this.sendtext(new message(i.name,xsockets.events.init))),i},n.prototype.disposeController=function(n){var t=this._controllers.indexOf(n,0);t>-1&&this._controllers.splice(t,1)},n.prototype.sendtext=function(n){this.socket!=undefined&&this.socket.send(n)},n.prototype.isConnected=function(){return this.socket!==undefined&&this.socket.readyState===WebSocket.OPEN},n.prototype.querystring=function(){var n="?";for(var t in this._parameters)n+=t+"="+encodeURIComponent(this._parameters[t])+"&";return n.slice(0,n.length-1)},n}();